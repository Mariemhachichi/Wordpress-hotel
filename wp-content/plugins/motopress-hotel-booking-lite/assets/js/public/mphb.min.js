!function(l){l(function(){MPHB.DateRules=can.Construct.extend({},{dates:{},init:function(e){this.dates=e},canCheckIn:function(e){var t=this.formatDate(e);return!this.dates.hasOwnProperty(t)||!this.dates[t].not_check_in&&!this.dates[t].not_stay_in},canCheckOut:function(e){var t=this.formatDate(e);return!this.dates.hasOwnProperty(t)||!this.dates[t].not_check_out},canStayIn:function(e){var t=this.formatDate(e);return!this.dates.hasOwnProperty(t)||!this.dates[t].not_stay_in},getNearestNotStayInDate:function(e,t){var a=MPHB.Utils.cloneDate(t),i=l.datepick.formatDate("yyyy-mm-dd",e),n=l.datepick.formatDate("yyyy-mm-dd",t);return l.each(this.dates,function(e,t){return!(n<e)&&(e<i||(t.not_stay_in?(a=l.datepick.parseDate("yyyy-mm-dd",e),!1):void 0))}),a},formatDate:function(e){return l.datepick.formatDate("yyyy-mm-dd",e)}}),can.Control("MPHB.Datepicker",{},{form:null,hiddenElement:null,roomTypeId:null,init:function(e,t){this.form=t.form,this.roomTypeId=t.hasOwnProperty("roomTypeId")?t.roomTypeId:0,this.setupHiddenElement(),this.initDatepick()},setupHiddenElement:function(){var e=this.element.attr("id")+"-hidden";if(this.hiddenElement=l("#"+e),this.hiddenElement.val()){var t=l.datepick.parseDate(MPHB._data.settings.dateTransferFormat,this.hiddenElement.val()),a=l.datepick.formatDate(MPHB._data.settings.dateFormat,t);this.element.val(a)}else;},initDatepick:function(){var e={dateFormat:MPHB._data.settings.dateFormat,altFormat:MPHB._data.settings.dateTransferFormat,altField:this.hiddenElement,minDate:MPHB.HotelDataManager.myThis.today,monthsToShow:MPHB._data.settings.numberOfMonthDatepicker,firstDay:MPHB._data.settings.firstDay,pickerClass:MPHB._data.settings.datepickerClass,useMouseWheel:!1},t=l.extend(e,this.getDatepickSettings());this.element.datepick(t)},getDatepickSettings:function(){return{}},getDate:function(){var e=this.element.val(),t=null;try{t=l.datepick.parseDate(MPHB._data.settings.dateFormat,e)}catch(e){t=null}return t},getFormattedDate:function(e){void 0===e&&(e=MPHB._data.settings.dateFormat);var t=this.getDate();return t?l.datepick.formatDate(e,t):""},setDate:function(e){this.element.datepick("setDate",e)},getOption:function(e){return this.element.datepick("option",e)},setOption:function(e,t){this.element.datepick("option",e,t)},getMinDate:function(){var e=this.getOption("minDate");return null!==e&&""!==e?MPHB.Utils.cloneDate(e):null},getMaxDate:function(){var e=this.getOption("maxDate");return null!==e&&""!==e?MPHB.Utils.cloneDate(e):null},getMaxAdvanceDate:function(){var e=this.getOption("maxAdvanceDate");return e?MPHB.Utils.cloneDate(e):null},clear:function(){this.element.datepick("clear")},formatDate:function(e,t){return t=void 0!==t?t:"yyyy-mm-dd",l.datepick.formatDate(t,e)},refresh:function(){l.datepick._update(this.element[0],!0),l.datepick._updateInput(this.element[0],!1)}}),MPHB.FlexsliderGallery=can.Control.extend({},{sliderEl:null,navSliderEl:null,groupId:null,init:function(e,t){this.sliderEl=e,this.groupId=e.data("group");var a=l('.mphb-gallery-thumbnail-slider[data-group="'+this.groupId+'"]');a.length&&(this.navSliderEl=a);var i=this;l(window).on("load",function(){i.initSliders()}),"complete"==document.readyState&&this.initSliders()},initSliders:function(){if(!this.slidersLoaded){var e=this.sliderEl.data("flexslider-atts");if(this.navSliderEl){var t=this.navSliderEl.data("flexslider-atts");t.asNavFor='.mphb-flexslider-gallery-wrapper[data-group="'+this.groupId+'"]',t.itemWidth=this.navSliderEl.find("ul > li img").width(),e.sync='.mphb-gallery-thumbnail-slider[data-group="'+this.groupId+'"]',this.navSliderEl.addClass("flexslider mphb-flexslider mphb-gallery-thumbnails-slider").flexslider(t)}this.sliderEl.addClass("flexslider mphb-flexslider mphb-gallery-slider").flexslider(e),this.slidersLoaded=!0}}}),MPHB.format_price=function(e,t){t=t||{};var a=MPHB._data.settings.currency;t=l.extend({trim_zeros:!1},a,t),e=MPHB.number_format(e,t.decimals,t.decimal_separator,t.thousand_separator);var i=t.price_format.replace("%s",e);if(t.trim_zeros){var n=new RegExp("\\"+t.decimal_separator+"0+$|(\\"+t.decimal_separator+"\\d*[1-9])0+$");i=i.replace(n,"$1")}return'<span class="mphb-price">'+i+"</span>"},MPHB.number_format=function(e,t,a,i){var n,s,r="";return t=t||0,a=a||".",i=i||",",e<0&&(r="-",e*=-1),3<(s=(n=parseInt(e=(+e||0).toFixed(t))+"").length)?s%=3:s=0,r+(s?n.substr(0,s)+i:"")+n.substr(s).replace(/(\d{3})(?=\d)/g,"$1"+i)+(t?a+Math.abs(e-n).toFixed(t).replace(/-/,0).slice(2):"")},MPHB.post=function(e,t,a){e="mphb_"+e,t=l.extend({action:e,mphb_nonce:MPHB._data.nonces[e],lang:MPHB._data.settings.currentLanguage},t);var i=l.extend({url:MPHB._data.ajaxUrl,type:"POST",dataType:"json",data:t},a);return l.ajax(i)},can.Construct("MPHB.Season",{},{startDate:null,endDate:null,allowedDays:[],init:function(e){var t=MPHB._data.settings.dateTransferFormat;this.startDate=l.datepick.parseDate(t,e.start_date),this.endDate=l.datepick.parseDate(t,e.end_date),this.allowedDays=e.allowed_days},isContainDate:function(e){return e>=this.startDate&&e<=this.endDate&&MPHB.Utils.inArray(e.getDay(),this.allowedDays)}}),MPHB.ReservationRulesChecker=can.Construct.extend({myThis:null},{rules:{checkInDays:{},checkOutDays:{},minStay:{},maxStay:{},minAdvance:{},maxAdvance:{}},init:function(e){this.rules.checkInDays=l.map(e.check_in_days,function(e){return new MPHB.Rules.CheckInDayRule(e)}),this.rules.checkOutDays=l.map(e.check_out_days,function(e){return new MPHB.Rules.CheckOutDayRule(e)}),this.rules.minStay=l.map(e.min_stay_length,function(e){return new MPHB.Rules.MinDaysRule(e)}),this.rules.maxStay=l.map(e.max_stay_length,function(e){return new MPHB.Rules.MaxDaysRule(e)}),this.rules.minAdvance=l.map(e.min_advance_reservation,function(e){return new MPHB.Rules.MinAdvanceDaysRule(e)}),this.rules.maxAdvance=l.map(e.max_advance_reservation,function(e){return new MPHB.Rules.MaxAdvanceDaysRule(e)})},getActualRule:function(e,a,i){var n=null;return l.each(this.rules[e],function(e,t){if(t.isActualRule(a,i))return n=t,!1}),n},getActualCombinedRule:function(e,i){var n=[],s=[];return l.each(this.rules[e],function(e,t){var a=MPHB.Utils.arrayDiff(t.roomTypeIds,n);if(a.length&&t.isActualForDate(i))return s.push(t),n=n.concat(a),!t.isAllRoomTypeRule()&&(!!MPHB.Utils.arrayDiff(MPHB._data.allRoomTypeIds,n).length&&void 0)}),this.combineRules(e,s)},combineRules:function(e,t){var a;switch(e){case"checkInDays":var i=[];l.each(t,function(e,t){i=i.concat(t.days)}),i=MPHB.Utils.arrayUnique(i),a=new MPHB.Rules.CheckInDayRule({season_ids:[0],room_type_ids:[0],check_in_days:i});break;case"checkOutDays":i=[];l.each(t,function(e,t){i=i.concat(t.days)}),i=MPHB.Utils.arrayUnique(i),a=new MPHB.Rules.CheckOutDayRule({season_ids:[0],room_type_ids:[0],check_out_days:i});break;case"minStay":var n=MPHB.Utils.arrayMin(l.map(t,function(e){return e.min}));a=new MPHB.Rules.MinDaysRule({season_ids:[0],room_type_ids:[0],min_stay_length:n});break;case"maxStay":n=MPHB.Utils.arrayMax(l.map(t,function(e){return e.max}));a=new MPHB.Rules.MaxDaysRule({season_ids:[0],room_type_ids:[0],max_stay_length:n});break;case"minAdvance":n=MPHB.Utils.arrayMin(l.map(t,function(e){return e.min}));a=new MPHB.Rules.MinAdvanceDaysRule({season_ids:[0],room_type_ids:[0],min_advance_reservation:n});break;case"maxAdvance":n=MPHB.Utils.arrayMax(l.map(t,function(e){return e.max}));a=new MPHB.Rules.MaxAdvanceDaysRule({season_ids:[0],room_type_ids:[0],max_advance_reservation:n})}return a},isCheckInSatisfy:function(e,t){return t?this.getActualRule("checkInDays",e,t).verify(e):this.getActualCombinedRule("checkInDays",e).verify(e)},isCheckOutSatisfy:function(e,t,a){return a?this.getActualRule("checkOutDays",e,a).verify(e,t):this.getActualCombinedRule("checkOutDays",e).verify(e,t)},getMinStay:function(e,t){return t?this.getActualRule("minStay",e,t).min:this.getActualCombinedRule("minStay",e).min},getMaxStay:function(e,t){return t?this.getActualRule("maxStay",e,t).max:this.getActualCombinedRule("maxStay",e).max},getToday:function(){return MPHB.HotelDataManager.myThis.today},getMinAdvance:function(e){return e?this.getActualRule("minAdvance",this.getToday(),e).min:this.getActualCombinedRule("minAdvance",this.getToday()).min},getMaxAdvance:function(e){return e?this.getActualRule("maxAdvance",this.getToday(),e).max:this.getActualCombinedRule("maxAdvance",this.getToday()).max},getMinCheckInDate:function(e){var t=this.getMinAdvance(e);return 0<t?l.datepick.add(MPHB.Utils.cloneDate(this.getToday()),t,"d"):MPHB.Utils.cloneDate(this.getToday())},getMaxAdvanceDate:function(e){var t=this.getMaxAdvance(e);return 0<t?l.datepick.add(MPHB.Utils.cloneDate(this.getToday()),t,"d"):null},getMinCheckOutDate:function(e,t){var a=this.getMinStay(e,t);return l.datepick.add(MPHB.Utils.cloneDate(e),a,"d")},getMaxCheckOutDate:function(e,t){var a=this.getMaxStay(e,t);return l.datepick.add(MPHB.Utils.cloneDate(e),a,"d")}}),MPHB.Rules={},MPHB.Rules.BasicRule=can.Construct.extend({},{seasonIds:[],roomTypeIds:[],init:function(e){this.seasonIds=e.season_ids,this.roomTypeIds=e.room_type_ids},isActualRule:function(e,t){return this.isActualForRoomType(t)&&this.isActualForDate(e)},isActualForRoomType:function(e){return MPHB.Utils.inArray(e,this.roomTypeIds)||MPHB.Utils.inArray(0,this.roomTypeIds)},isActualForDate:function(a){if(this.isAllSeasonRule())return!0;var i=!1;return l.each(this.seasonIds,function(e,t){if(MPHB.HotelDataManager.myThis.seasons[t]&&MPHB.HotelDataManager.myThis.seasons[t].isContainDate(a))return!(i=!0)}),i},verify:function(e,t){return!0},isAllSeasonRule:function(){return MPHB.Utils.inArray(0,this.seasonIds)},isAllRoomTypeRule:function(){return MPHB.Utils.inArray(0,this.roomTypeIds)},isGlobalRule:function(){return this.isAllSeasonRule()&&this.isAllRoomTypeRule()}}),MPHB.Rules.BasicRule("MPHB.Rules.CheckInDayRule",{},{days:[],init:function(e){this._super(e),this.days=e.check_in_days},verify:function(e,t){return MPHB.Utils.inArray(e.getDay(),this.days)}}),MPHB.Rules.BasicRule("MPHB.Rules.CheckOutDayRule",{},{days:[],init:function(e){this._super(e),this.days=e.check_out_days},verify:function(e,t){return MPHB.Utils.inArray(t.getDay(),this.days)}}),MPHB.Rules.BasicRule("MPHB.Rules.MinDaysRule",{},{min:null,init:function(e){this._super(e),this.min=e.min_stay_length},verify:function(e,t){var a=l.datepick.add(MPHB.Utils.cloneDate(e),this.min,"d");return MPHB.Utils.formatDateToCompare(t)>=MPHB.Utils.formatDateToCompare(a)}}),MPHB.Rules.BasicRule("MPHB.Rules.MaxDaysRule",{},{max:null,init:function(e){this._super(e),this.max=0!=e.max_stay_length?e.max_stay_length:3652},verify:function(e,t){var a=l.datepick.add(MPHB.Utils.cloneDate(e),this.max,"d");return MPHB.Utils.formatDateToCompare(t)<=MPHB.Utils.formatDateToCompare(a)}}),can.Construct("MPHB.HotelDataManager",{myThis:null,ROOM_STATUS_AVAILABLE:"available",ROOM_STATUS_NOT_AVAILABLE:"not-available",ROOM_STATUS_BOOKED:"booked",ROOM_STATUS_PAST:"past",ROOM_STATUS_EARLIER_MIN_ADVANCE:"earlier-min-advance",ROOM_STATUS_LATER_MAX_ADVANCE:"later-max-advance",ROOM_STATUS_BOOKING_BUFFER:"booking-buffer"},{today:null,roomTypesData:{},translationIds:{},dateRules:null,typeRules:{},seasons:{},init:function(e){(MPHB.HotelDataManager.myThis=this).setToday(l.datepick.parseDate(MPHB._data.settings.dateTransferFormat,e.today)),this.initSeasons(e.seasons),this.initRoomTypesData(e.roomTypesData,e.rules),this.initRules(e.rules)},initRoomTypesData:function(e,n){var s=this;l.each(e,function(e,t){e=parseInt(e);var a=parseInt(t.originalId);a!=e&&(s.translationIds.hasOwnProperty(a)||(s.translationIds[a]=[]),s.translationIds[a].push(e));var i=new MPHB.RoomTypeData(e,t);l.each(n.dates,function(e,t){t.not_stay_in&&i.blockAllRoomsOnDate(e)}),n.blockedTypes.hasOwnProperty(a)&&l.each(n.blockedTypes[a],function(e,t){t.not_stay_in&&i.blockAllRoomsOnDate(e)}),s.roomTypesData[e]=i})},initRules:function(e){this.dateRules=new MPHB.DateRules(e.dates);var i=this;l.each(e.blockedTypes,function(e,a){i.typeRules[e]=new MPHB.DateRules(a),i.translationIds.hasOwnProperty(e)&&l.each(i.translationIds[e],function(e,t){i.typeRules[t]=new MPHB.DateRules(a)})}),this.reservationRules=new MPHB.ReservationRulesChecker(e.reservationRules)},initSeasons:function(e){l.each(e,this.proxy(function(e,t){this.seasons[e]=new MPHB.Season(t)}))},setToday:function(e){this.today=e},getRoomTypeData:function(e){return!!this.roomTypesData.hasOwnProperty(e)&&this.roomTypesData[e]},fillDateCellData:function(e,t,a,i){i=i||t;var n=[],s=[],r=e.roomTypeId;return this.notStayIn(t,r)&&(n.push(MPHB._data.translations.notStayIn),s.push("mphb-not-stay-in-date")),"checkIn"==a&&this.notCheckIn(t,r,i)&&(n.push(MPHB._data.translations.notCheckIn),s.push("mphb-not-check-in-date")),"checkOut"==a&&this.notCheckOut(t,r,i)&&(n.push(MPHB._data.translations.notCheckOut),s.push("mphb-not-check-out-date")),MPHB.Utils.compareDates(t,this.today,">=")&&this.isEarlierThanMinAdvanceDate(t,r)&&n.push(MPHB._data.translations.earlierMinAdvance),"checkOut"!=a&&this.isLaterThamMaxAdvanceDate(t,r)&&n.push(MPHB._data.translations.laterMaxAdvance),n.length&&(e.title+=" "+MPHB._data.translations.rules+" "+n.join(", ")),s.length&&(e.dateClass+=(e.dateClass.length?" ":"")+s.join(" ")),e},notStayIn:function(e,t){var a=this.dateRules.canStayIn(e);return this.typeRules[t]&&(a=a&&this.typeRules[t].canStayIn(e)),!a},notCheckIn:function(e,t,a){var i=this.dateRules.canCheckIn(e);return i=i&&this.reservationRules.isCheckInSatisfy(e,t),this.typeRules[t]&&(i=i&&this.typeRules[t].canCheckIn(e)),!i},notCheckOut:function(e,t,a){var i=this.dateRules.canCheckOut(e);return i=i&&this.reservationRules.isCheckOutSatisfy(a,e,t),this.typeRules[t]&&(i=i&&this.typeRules[t].canCheckOut(e)),!i},isEarlierThanMinAdvanceDate:function(e,t){var a=this.reservationRules.getMinCheckInDate(t);return null!=a&&MPHB.Utils.compareDates(e,a,"<")},isLaterThamMaxAdvanceDate:function(e,t){var a=this.reservationRules.getMaxAdvanceDate(t);return null!=a&&MPHB.Utils.compareDates(e,a,">")}}),MPHB.TermsSwitcher=can.Construct.extend({},{init:function(e,t){var a=e.children(".mphb-terms-and-conditions");e.find(".mphb-terms-and-conditions-link").on("click",function(e){e.preventDefault(),a.toggleClass("mphb-active")})}}),MPHB.Utils=can.Construct.extend({formatDateToCompare:function(e){return l.datepick.formatDate("yyyymmdd",e)},compareDates:function(e,t,a){e=MPHB.Utils.formatDateToCompare(e),t=MPHB.Utils.formatDateToCompare(t);if(null==a)return t<e?1:e<t?-1:0;switch(a){case">":return t<e;case">=":return t<=e;case"<":return e<t;case"<=":return e<=t;case"=":case"==":return e==t;case"!=":return e!=t;default:return!1}},cloneDate:function(e){return new Date(e.getTime())},arrayUnique:function(e){return e.filter(function(e,t,a){return a.indexOf(e)===t})},arrayMin:function(e){return Math.min.apply(null,e)},arrayMax:function(e){return Math.max.apply(null,e)},arrayDiff:function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},inArray:function(e,t){return-1!==t.indexOf(e)}},{}),MPHB.Gateway=can.Construct.extend({},{amount:0,paymentDescription:"",init:function(e){this.billingSection=e.billingSection,this.initSettings(e.settings)},initSettings:function(e){this.amount=e.amount,this.paymentDescription=e.paymentDescription},canSubmit:function(e,t){return Promise.resolve(!0)},updateData:function(e){this.amount=e.amount,this.paymentDescription=e.paymentDescription},afterSelection:function(e){},cancelSelection:function(){},onInput:function(e,t){}}),MPHB.BeanstreamGateway=MPHB.Gateway.extend({},{scriptUrl:"",isCanSubmit:!1,loadHandler:null,validityHandler:null,tokenRequestHandler:null,tokenUpdatedHandler:null,initSettings:function(e){this._super(e),this.scriptUrl=e.scriptUrl||"https://payform.beanstream.com/v1.1.0/payfields/beanstream_payfields.js",this.validityHandler=this.validityChanged.bind(this),this.tokenRequestHandler=this.tokenRequested.bind(this),this.tokenUpdatedHandler=this.tokenUpdated.bind(this)},canSubmit:function(e,t){return Promise.relosve(this.isCanSubmit)},afterSelection:function(t){if(this._super(t),0<t.length){var e=document.createElement("script");e.id="payfields-script",e.src=this.scriptUrl,e.dataset.submitform="true",e.dataset.async="true",null!=this.loadHandler&&l(document).off("beanstream_payfields_loaded",this.loadHandler),this.loadHandler=function(e){l("[data-beanstream-id]").appendTo(t)},l(document).on("beanstream_payfields_loaded",this.loadHandler),t.append(e),t.removeClass("mphb-billing-fields-hidden")}l(document).on("beanstream_payfields_inputValidityChanged",this.validityHandler).on("beanstream_payfields_tokenRequested",this.tokenRequestHandler).on("beanstream_payfields_tokenUpdated",this.tokenUpdatedHandler)},cancelSelection:function(){l(document).off("beanstream_payfields_inputValidityChanged",this.validityHandler).off("beanstream_payfields_tokenRequested",this.tokenRequestHandler).off("beanstream_payfields_tokenUpdated",this.tokenUpdatedHandler)},validityChanged:function(e){(e.eventDetail||e.originalEvent.eventDetail).isValid||(this.isCanSubmit=!1)},tokenRequested:function(e){this.billingSection.showPreloader()},tokenUpdated:function(e){var t=e.eventDetail||e.originalEvent.eventDetail;t.success?this.isCanSubmit=!0:(this.isCanSubmit=!1,this.billingSection.showError(MPHB._data.translations.tokenizationFailure.replace("(%s)",t.message))),this.billingSection.hidePreloader()}}),MPHB.BillingSection=can.Control.extend({},{updateBillingFieldsTimeout:null,parentForm:null,billingFieldsWrapperEl:null,gateways:{},amounts:{},lastGatewayId:null,init:function(e,t){this.parentForm=t.form,this.billingFieldsWrapperEl=this.element.find(".mphb-billing-fields"),this.initGateways(t.gateways)},initGateways:function(e){var n=this;l.each(e,function(e,t){var a={billingSection:n,settings:t},i=null;switch(e){case"braintree":i=new MPHB.BraintreeGateway(a);break;case"beanstream":i=new MPHB.BeanstreamGateway(a);break;case"stripe":i=new MPHB.StripeGateway(a);break;default:i=new MPHB.Gateway(a)}null!=i&&(n.gateways[e]=i,n.amounts[e]=t.amount)}),this.notifySelectedGateway()},'[name="mphb_gateway_id"] change':function(e,t){var a=this,i=e.val();this.showPreloader(),this.billingFieldsWrapperEl.empty().addClass("mphb-billing-fields-hidden"),clearTimeout(this.updateBillingFieldsTimeout),this.updateBillingFieldsTimeout=setTimeout(function(){var e=a.parentForm.parseFormToJSON();l.ajax({url:MPHB._data.ajaxUrl,type:"GET",dataType:"json",data:{action:"mphb_get_billing_fields",mphb_nonce:MPHB._data.nonces.mphb_get_billing_fields,mphb_gateway_id:i,formValues:e,lang:MPHB._data.settings.currentLanguage},success:function(e){e.hasOwnProperty("success")?e.success?(a.lastGatewayId&&a.gateways[a.lastGatewayId].cancelSelection(),a.billingFieldsWrapperEl.html(e.data.fields),e.data.hasVisibleFields?a.billingFieldsWrapperEl.removeClass("mphb-billing-fields-hidden"):a.billingFieldsWrapperEl.addClass("mphb-billing-fields-hidden"),a.notifySelectedGateway(i)):a.showError(e.data.message):a.showError(MPHB._data.translations.errorHasOccured)},error:function(e){a.showError(MPHB._data.translations.errorHasOccured)},complete:function(e){a.hidePreloader()}})},500)},hideErrors:function(){this.parentForm.hideErrors()},showError:function(e){this.parentForm.showError(e)},showPreloader:function(){this.parentForm.showPreloader()},hidePreloader:function(){this.parentForm.hidePreloader()},onInput:function(e,t){var a=this.gateways[this.getSelectedGateway()];a&&a.onInput(e,t)},canSubmit:function(e,t){var a=this.gateways[this.getSelectedGateway()];return a?a.canSubmit(e,t):Promise.resolve(!0)},getSelectedGateway:function(){var e=this.element.find('[name="mphb_gateway_id"]');return 1==e.length?e.val():e.filter(":checked").val()},getSelectedGatewayAmount:function(){var e=this.getSelectedGateway();return this.amounts.hasOwnProperty(e)?this.amounts[e]:0},notifySelectedGateway:function(e){if((e=e||this.getSelectedGateway())&&this.gateways.hasOwnProperty(e)){this.gateways[e].afterSelection(this.billingFieldsWrapperEl);var t=this.parentForm.getCountry();!1!==t&&this.gateways[e].onInput("country",t)}this.lastGatewayId=e},updateGatewaysData:function(e){var a=this;l.each(e,function(e,t){a.gateways.hasOwnProperty(e)&&a.gateways[e].updateData(t)})}}),MPHB.BraintreeGateway=MPHB.Gateway.extend({},{clientToken:"",checkout:null,initSettings:function(e){this._super(e),this.clientToken=e.clientToken},canSubmit:function(e,t){return Promise.resolve(this.isNonceStored())},storeNonce:function(e){this.billingSection.billingFieldsWrapperEl.find('[name="mphb_braintree_payment_nonce"]').val(e)},isNonceStored:function(){var e=this.billingSection.billingFieldsWrapperEl.find('[name="mphb_braintree_payment_nonce"]');return e.length&&""!=e.val()},afterSelection:function(e){if(this._super(e),null!=braintree){var t="mphb-braintree-container-"+this.clientToken.substr(0,8);e.append('<div id="'+t+'"></div>');var a=this;braintree.setup(this.clientToken,"dropin",{container:t,onReady:function(e){a.checkout=e},onPaymentMethodReceived:function(e){a.storeNonce(e.nonce),a.billingSection.parentForm.element.submit(),a.billingSection.showPreloader()}}),e.removeClass("mphb-billing-fields-hidden")}},cancelSelection:function(){if(this._super(),null!=this.checkout){var e=this;this.checkout.teardown(function(){e.checkout=null})}}}),MPHB.CouponSection=can.Control.extend({},{applyCouponTimeout:null,parentForm:null,appliedCouponEl:null,couponEl:null,messageHolderEl:null,init:function(e,t){this.parentForm=t.form,this.couponEl=e.find('[name="mphb_coupon_code"]'),this.appliedCouponEl=e.find('[name="mphb_applied_coupon_code"]'),this.messageHolderEl=e.find(".mphb-coupon-message")},".mphb-apply-coupon-code-button click":function(e,t){t.preventDefault(),t.stopPropagation(),this.clearMessage();var a=this.couponEl.val();if(a.length){this.appliedCouponEl.val("");var i=this;this.showPreloader(),clearTimeout(this.applyCouponTimeout),this.applyCouponTimeout=setTimeout(function(){var e=i.parentForm.parseFormToJSON();l.ajax({url:MPHB._data.ajaxUrl,type:"POST",dataType:"json",data:{action:"mphb_apply_coupon",mphb_nonce:MPHB._data.nonces.mphb_apply_coupon,mphb_coupon_code:a,formValues:e,lang:MPHB._data.settings.currentLanguage},success:function(e){e.hasOwnProperty("success")?e.success?(i.parentForm.setCheckoutData(e.data),i.couponEl.val(""),i.appliedCouponEl.val(e.data.coupon.applied_code),i.showMessage(e.data.coupon.message)):i.showMessage(e.data.message):i.showMessage(MPHB._data.translations.errorHasOccured)},error:function(e){i.showMessage(MPHB._data.translations.errorHasOccured)},complete:function(e){i.hidePreloader()}})},500)}else this.showMessage(MPHB._data.translations.emptyCouponCode)},removeCoupon:function(){this.appliedCouponEl.val(""),this.clearMessage()},showPreloader:function(){this.parentForm.showPreloader()},hidePreloader:function(){this.parentForm.hidePreloader()},clearMessage:function(){this.messageHolderEl.html("").addClass("mphb-hide")},showMessage:function(e){this.messageHolderEl.html(e).removeClass("mphb-hide")}}),MPHB.CheckoutForm=can.Control.extend({myThis:null},{priceBreakdownTableEl:null,bookBtnEl:null,errorsWrapperEl:null,preloaderEl:null,billingSection:null,couponSection:null,waitResponse:!1,updateInfoTimeout:null,updateRatesTimeout:null,freeBooking:!1,currentInfoAjax:null,toPay:0,init:function(e,t){(MPHB.CheckoutForm.myThis=this).bookBtnEl=this.element.find("input[type=submit]"),this.errorsWrapperEl=this.element.find(".mphb-errors-wrapper"),this.preloaderEl=this.element.find(".mphb-preloader"),this.priceBreakdownTableEl=this.element.find("table.mphb-price-breakdown"),MPHB._data.settings.useBilling&&(this.billingSection=new MPHB.BillingSection(this.element.find("#mphb-billing-details"),{form:this,gateways:MPHB._data.gateways})),MPHB._data.settings.useCoupons&&(this.couponSection=new MPHB.CouponSection(this.element.find("#mphb-coupon-details"),{form:this})),this.element.find(".mphb-room-details").each(function(e,t){new MPHB.GuestsChooser(l(t),{minAdults:MPHB._data.checkout.min_adults,minChildren:MPHB._data.checkout.min_children})})},setTotal:function(e,t){this.toPay=e,this.element.find(".mphb-total-price-field").html(t)},setDeposit:function(e,t){this.toPay=e,this.element.find(".mphb-deposit-amount-field").html(t)},setupPriceBreakdown:function(e){this.priceBreakdownTableEl.replaceWith(e),this.priceBreakdownTableEl=this.element.find("table.mphb-price-breakdown")},updateCheckoutInfo:function(){var t=this;t.hideErrors(),t.showPreloader(),clearTimeout(this.updateInfoTimeout),this.updateInfoTimeout=setTimeout(function(){var e=t.parseFormToJSON();t.currentInfoAjax=l.ajax({url:MPHB._data.ajaxUrl,type:"GET",dataType:"json",data:{action:"mphb_update_checkout_info",mphb_nonce:MPHB._data.nonces.mphb_update_checkout_info,formValues:e,lang:MPHB._data.settings.currentLanguage},beforeSend:function(){null!=t.currentInfoAjax&&(t.currentInfoAjax.abort(),t.hideErrors())},success:function(e){e.hasOwnProperty("success")?e.success?t.setCheckoutData(e.data):t.showError(e.data.message):t.showError(MPHB._data.translations.errorHasOccured)},error:function(e){t.showError(MPHB._data.translations.errorHasOccured)},complete:function(e){t.hidePreloader(),t.currentInfoAjax=null}})},500)},setCheckoutData:function(e){this.setTotal(e.newAmount,e.priceHtml),this.setupPriceBreakdown(e.priceBreakdown),MPHB._data.settings.useBilling&&(this.setDeposit(e.depositAmount,e.depositPrice),this.billingSection.updateGatewaysData(e.gateways),e.isFree?this.setFreeMode():this.unsetFreeMode())},setFreeMode:function(){this.freeBooking=!0,this.billingSection.element.addClass("mphb-hide"),this.element.append(l("<input />",{type:"hidden",name:"mphb_gateway_id",value:"manual",id:"mphb-manual-payment-input"}))},unsetFreeMode:function(){this.freeBooking=!1,this.billingSection.element.removeClass("mphb-hide"),this.element.find("#mphb-manual-payment-input").remove()},updateRatePrices:function(e){if(e&&e.length){var t=parseInt(e.attr("data-index")),a=e.find(".mphb_sc_checkout-rate"),i=l.map(a,function(e){return parseInt(e.value)});if(!(i.length<=1)){var n=this.parseFormToJSON(),s=n.mphb_room_details[t],r=s.adults||"",o=s.children||"";clearTimeout(this.updateRatesTimeout),this.updateRatesTimeout=setTimeout(function(){l.ajax({url:MPHB._data.ajaxUrl,type:"GET",dataType:"json",data:{action:"mphb_update_rate_prices",mphb_nonce:MPHB._data.nonces.mphb_update_rate_prices,rates:i,adults:r,children:o,check_in_date:n.mphb_check_in_date,check_out_date:n.mphb_check_out_date,lang:MPHB._data.settings.currentLanguage},success:function(e){if(e.hasOwnProperty("success")){var n=e.data;l.each(a,function(e,t){var a=t.value;if(null!=n[a]){var i=l(t).parent().children("strong");i.children(".mphb-price").remove(),i.append(n[a])}})}}})},500)}}},".mphb_checkout-guests-chooser change":function(e,t){this.updateRatePrices(e.closest(".mphb-room-details")),this.updateCheckoutInfo()},".mphb_checkout-rate change":function(e,t){this.updateCheckoutInfo()},".mphb_checkout-service, .mphb_checkout-service-adults change":function(e,t){this.updateCheckoutInfo()},".mphb_checkout-service-quantity input":function(e,t){this.updateCheckoutInfo()},'select[name="mphb_country"] change':function(e,t){if(null!=this.billingSection){var a=l(e).val();this.billingSection.onInput("country",a)}},getCountry:function(){return this.getCustomerDetail("country")},".mphb-price-breakdown-expand click":function(e,t){t.preventDefault(),l(e).blur();var a=l(e).parents("tr.mphb-price-breakdown-group");a.find(".mphb-price-breakdown-rate").toggleClass("mphb-hide"),a.nextUntil("tr.mphb-price-breakdown-group").toggleClass("mphb-hide"),l(e).children(".mphb-inner-icon").toggleClass("mphb-hide")},hideErrors:function(){this.errorsWrapperEl.empty().addClass("mphb-hide")},showError:function(e){this.errorsWrapperEl.html(e).removeClass("mphb-hide")},showPreloader:function(){this.waitResponse=!0,this.bookBtnEl.attr("disabled","disabled"),this.preloaderEl.removeClass("mphb-hide")},hidePreloader:function(){this.waitResponse=!1,this.bookBtnEl.removeAttr("disabled"),this.preloaderEl.addClass("mphb-hide")},parseFormToJSON:function(){return this.element.serializeJSON()},getCustomerDetail:function(e){var t=this.element.find("#mphb_"+e);return 0<t.length&&t.val()},getCustomerDetails:function(){var a={email:"",first_name:"",last_name:""},i=this;if(["name","first_name","last_name","email","phone","country","address1","city","state","zip"].forEach(function(e){var t=i.getCustomerDetail(e);!1!==t&&(a[e]=t)}),!a.name){var e=a.first_name+" "+a.last_name;a.name=e.trim()}return a},getToPayAmount:function(){var e=this.toPay;return 0==e&&(e=this.billingSection.getSelectedGatewayAmount()),e},submit:function(e,t){if(this.waitResponse)return!1;if(MPHB._data.settings.useBilling&&!this.freeBooking){var a=this.getToPayAmount(),i=this.getCustomerDetails(),n=this;return this.showPreloader(),this.billingSection.canSubmit(a,i).then(function(e){e?n.element[0].submit():n.hidePreloader()}).catch(function(e){n.hidePreloader(),console.error("Billing error. "+e.message)}),!1}},"#mphb-price-details .mphb-remove-coupon click":function(e,t){t.preventDefault(),t.stopPropagation(),MPHB._data.settings.useCoupons&&(this.couponSection.removeCoupon(),this.updateCheckoutInfo())}}),MPHB.GuestsChooser=can.Control.extend({},{$adultsChooser:null,$childrenChooser:null,minAdults:0,minChildren:0,maxAdults:0,maxChildren:0,totalCapacity:0,init:function(e,t){var a=e.find(".mphb_checkout-guests-chooser");a.length<2||(this.$adultsChooser=l(a[0]),this.$childrenChooser=l(a[1]),this.minAdults=t.minAdults,this.minChildren=t.minChildren,this.maxAdults=parseInt(this.$adultsChooser.data("max-allowed")),this.maxChildren=parseInt(this.$childrenChooser.data("max-allowed")),this.totalCapacity=parseInt(a.data("max-total")),this.maxAdults+this.maxChildren>this.totalCapacity&&this.$adultsChooser.on("change",this.limitChildren.bind(this)))},limitChildren:function(){var e=this.$adultsChooser.val(),t=this.findMax(e,this.minChildren,this.maxChildren);this.limitOptions(this.$childrenChooser,this.minChildren,t,e)},findMax:function(e,t,a){var i=this.totalCapacity;return""!==e&&(i=this.totalCapacity-e,i=Math.max(t,i)),Math.min(i,a)},limitOptions:function(e,t,i,a){var n=t;e.children().each(function(e,t){var a=t.value;""!==a&&(a=parseInt(a),i<a?l(t).remove():n<a&&(n=a))});for(var s=n+1;s<=i;s++){var r=jQuery('<option value="'+s+'">'+s+"</option>");e.append(r)}""!==a&&e.children(":selected").prop("selected",!1)}}),MPHB.StripeGateway=MPHB.Gateway.extend({},{publicKey:"",locale:"auto",currency:"EUR",successUrl:window.location.href,defaultCountry:"",paymentDescription:"Accommodation(s) reservation",statementDescriptor:"Hotel Booking",fullAddressRequired:!1,i18n:{},style:{},api:null,elements:null,cardControl:null,idealControl:null,ibanControl:null,payments:null,customer:null,defaultCustomer:null,mountWrapper:null,errorsWrapper:null,hasErrors:!1,undefinedError:MPHB._data.translations.errorHasOccured,init:function(e){this._super(e),this.api=Stripe(this.publicKey),this.elements=this.api.elements({locale:this.locale}),this.cardControl=this.elements.create("card",{style:this.style,hidePostalCode:this.fullAddressRequired}),this.idealControl=this.elements.create("idealBank",{style:this.style}),this.ibanControl=this.elements.create("iban",{style:this.style,supportedCountries:["SEPA"]}),this.payments=new MPHB.StripeGateway.PaymentMethods(e.settings.paymentMethods,this.defaultCountry),this.addListeners()},initSettings:function(e){this._super(e),this.publicKey=e.publicKey,this.locale=e.locale,this.currency=e.currency,this.successUrl=e.successUrl,this.defaultCountry=e.defaultCountry,this.paymentDescription=e.paymentDescription,this.statementDescriptor=e.statementDescriptor,this.fullAddressRequired=MPHB._data.settings.fullAddressRequired,this.defaultCustomer=e.customer,this.i18n=e.i18n,this.style=e.style},addListeners:function(){var e=this.onChange.bind(this);this.cardControl.on("change",e),this.ibanControl.on("change",e)},onChange:function(e){e.error?(this.showError(e.error.message),this.hasErrors=!0):(this.hideErrors(),this.hasErrors=!1)},onInput:function(e,t){"country"==e&&this.payments.selectCountry(t)},afterSelection:function(e){this._super(e),e.append(this.mountHtml()),this.mountWrapper=e,this.errorsWrapper=e.find("#mphb-stripe-errors"),this.cardControl.mount("#mphb-stripe-card-element"),this.payments.isEnabled("ideal")&&this.idealControl.mount("#mphb-stripe-ideal-element"),this.payments.isEnabled("sepa_debit")&&this.ibanControl.mount("#mphb-stripe-iban-element"),this.payments.mount(e);var t=this;this.payments.inputs.on("change",function(){switch(t.payments.currentPayment){case"card":t.cardControl.clear();break;case"ideal":t.idealControl.clear();break;case"sepa_debit":t.ibanControl.clear()}t.payments.selectPayment(this.value)}),e.removeClass("mphb-billing-fields-hidden")},cancelSelection:function(){this._super(),this.mountWrapper=null,this.errorsWrapper=null,this.cardControl.unmount(),this.payments.isEnabled("ideal")&&this.idealControl.unmount(),this.payments.isEnabled("sepa_debit")&&this.ibanControl.unmount(),this.payments.unmount()},canSubmit:function(e,t){return this.hasErrors?Promise.resolve(!1):(this.setCustomer(t),"card"==this.payments.currentPayment?this.createPaymentIntent(e).then(this.createCardPayment.bind(this)).then(this.handleStripeErrors.bind(this)).then(this.completeCardPayment.bind(this)):this.createSource(e).then(this.handleStripeErrors.bind(this)).then(this.completeSourcePayment.bind(this)))},setCustomer:function(e){var t=l.extend({},e);t.email||(t.email=this.defaultCustomer.email),t.name||(t.name=this.defaultCustomer.name,t.first_name=this.defaultCustomer.first_name,t.last_name=this.defaultCustomer.last_name),t.hasOwnProperty("country")||(t.country=this.payments.currentCountry),this.customer=t},createPaymentIntent:function(e){var n=this;return new Promise(function(a,i){MPHB.post("create_stripe_payment_intent",{amount:e,description:n.paymentDescription},{success:function(e){if(e.hasOwnProperty("success"))if(e.success){var t={id:e.data.id,client_secret:e.data.client_secret,object:"payment_intent"};a(t)}else n.showError(e.data.message),i(new Error(e.data.message));else n.showError(n.undefinedError),i(new Error(n.undefinedError))},error:function(e){n.showError(n.undefinedError),i(new Error(n.undefinedError))}})})},createCardPayment:function(e){return this.api.handleCardPayment(e.client_secret,this.cardControl,{payment_method_data:{billing_details:{name:this.customer.name,email:this.customer.email}}})},createSource:function(e){var t=this.payments.currentPayment,a=this.customer,i={type:t,amount:this.convertToSmallestUnit(e),currency:this.currency.toLowerCase(),owner:{name:a.name,email:a.email},mandate:{notification_method:"none"},redirect:{return_url:this.successUrl},statement_descriptor:this.statementDescriptor},n=null;switch(t){case"bancontact":0<=["en","de","fr","nl"].indexOf(this.locale)&&(i.bancontact={preferred_language:this.locale});break;case"ideal":n=this.idealControl;break;case"giropay":break;case"sepa_debit":n=this.ibanControl;break;case"sofort":i.sofort={country:a.country},0<=["de","en","es","it","fr","nl","pl"].indexOf(this.locale)&&(i.sofort.preferred_language=this.locale)}return null!=n?this.api.createSource(n,i):this.api.createSource(i)},handleStripeErrors:function(e){if(e.error)throw this.showError(e.error.message),new Error(e.error.message);return null!=e.paymentIntent?e.paymentIntent:e.source},completeCardPayment:function(e){if("succeeded"==e.status||"processing"==e.status)return this.saveToCheckout("payment_method",this.payments.currentPayment),this.saveToCheckout("payment_intent_id",e.id),!0;throw this.showError(this.undefinedError),new Error(this.undefinedError)},completeSourcePayment:function(e){return this.saveToCheckout("payment_method",this.payments.currentPayment),this.saveToCheckout("source_id",e.id),this.saveToCheckout("redirect_url",e.redirect.url),!0},saveToCheckout:function(e,t){this.mountWrapper.find("#mphb_stripe_"+e).val(t)},convertToSmallestUnit:function(e){switch(this.currency){case"BIF":case"CLP":case"DJF":case"GNF":case"JPY":case"KMF":case"KRW":case"MGA":case"PYG":case"RWF":case"UGX":case"VND":case"VUV":case"XAF":case"XOF":case"XPF":e=Math.floor(e);break;default:e=Math.round(100*e)}return e},mountHtml:function(){var e='<section id="mphb-stripe-payment-container" class="mphb-stripe-payment-container">';return e+=this.methodsHtml(),e+=this.fieldsHtml("card"),e+=this.fieldsHtml("bancontact"),e+=this.fieldsHtml("ideal"),e+=this.fieldsHtml("giropay"),e+=this.fieldsHtml("sepa_debit"),e+=this.fieldsHtml("sofort"),e+='<div id="mphb-stripe-errors"></div>',e+="</section>"},methodsHtml:function(){if(this.payments.onlyCardEnabled())return"";var n=this.i18n,s='<nav id="mphb-stripe-payment-methods">';return s+="<ul>",this.payments.forEach(function(e,t,a){if(t.isEnabled){var i=a.isSelected(e);s+='<li class="mphb-stripe-payment-method '+e+(i?" active":"")+'">',s+="<label>",s+='<input type="radio" name="stripe_payment_method" value="'+e+'"'+(i?' checked="checked"':"")+" />"+n[e],s+="</label>",s+="</li>"}}),s+="</ul>",s+="</nav>"},fieldsHtml:function(e){if(!this.payments.isEnabled(e))return"";var t="";switch(t+='<div class="mphb-stripe-payment-fields '+e+(this.payments.isSelected(e)?"":" mphb-hide")+'">',t+="<fieldset>",e){case"card":t+=this.cardHtml();break;case"ideal":t+=this.idealHtml();break;case"sepa_debit":t+=this.ibanHtml();break;default:t+=this.redirectHtml()}return t+="</fieldset>","sepa_debit"==e&&(t+='<p class="notice">'+this.i18n.iban_policy+"</p>"),t+="</div>"},cardHtml:function(){var e="";return this.payments.onlyCardEnabled()&&(e+='<label for="mphb-stripe-card-element">'+this.i18n.card_description+"</label>"),e+='<div id="mphb-stripe-card-element" class="mphb-stripe-element"></div>'},idealHtml:function(){return'<label for="mphb-stripe-ideal-element">'+this.i18n.ideal_bank+'</label><div id="mphb-stripe-ideal-element" class="mphb-stripe-element"></div>'},ibanHtml:function(){return'<label for="mphb-stripe-iban-element">'+this.i18n.iban+'</label><div id="mphb-stripe-iban-element" class="mphb-stripe-element"></div>'},redirectHtml:function(){return'<p class="notice">'+this.i18n.redirect_notice+"</p>"},showError:function(e){this.errorsWrapper.html(e).removeClass("mphb-hide")},hideErrors:function(){this.errorsWrapper.addClass("mphb-hide").text("")}}),MPHB.DirectBooking=can.Control.extend({},{reservationForm:null,elementsToHide:null,quantitySection:null,wrapperWithSelect:null,wrapperWithoutSelect:null,priceWrapper:null,quantitySelect:null,availableLabel:null,typeId:0,init:function(e,t){this.reservationForm=t.reservationForm,this.elementsToHide=e.find(".mphb-reserve-room-section, .mphb-rooms-quantity-wrapper, .mphb-regular-price"),this.quantitySection=e.find(".mphb-reserve-room-section"),this.wrapperWithSelect=this.quantitySection.find(".mphb-rooms-quantity-wrapper.mphb-rooms-quantity-multiple"),this.wrapperWithoutSelect=this.quantitySection.find(".mphb-rooms-quantity-wrapper.mphb-rooms-quantity-single"),this.priceWrapper=this.quantitySection.find(".mphb-period-price"),this.quantitySelect=this.quantitySection.find(".mphb-rooms-quantity"),this.availableLabel=this.quantitySection.find(".mphb-available-rooms-count"),this.typeId=e.find('input[name="mphb_room_type_id"]').val(),this.typeId=parseInt(this.typeId)},hideSections:function(){this.elementsToHide.addClass("mphb-hide")},showSections:function(e){this.quantitySection.removeClass("mphb-hide"),e&&this.priceWrapper.removeClass("mphb-hide")},resetQuantityOptions:function(e){this.quantitySelect.empty();for(var t=1;t<=e;t++){var a='<option value="'+t+'">'+t+"</option>";this.quantitySelect.append(a)}this.quantitySelect.val(1),this.availableLabel.text(e),1<e?this.wrapperWithSelect.removeClass("mphb-hide"):this.wrapperWithoutSelect.removeClass("mphb-hide")},setupPrice:function(e,t){this.priceWrapper.children(".mphb-price, .mphb-price-period").remove(),0<e&&""!=t&&this.priceWrapper.append(t)},showError:function(e){this.hideSections(),this.reservationForm.showError(e)},"input.mphb-datepick change":function(e,t){this.hideSections()},".mphb-reserve-btn click":function(e,t){t.preventDefault(),t.stopPropagation(),this.reservationForm.clearErrors(),this.reservationForm.setFormWaitingMode();var a=this.reservationForm.checkInDatepicker.getDate(),i=this.reservationForm.checkOutDatepicker.getDate();if(!a||!i)return a?this.showError(MPHB._data.translations.checkOutNotValid):this.showError(MPHB._data.translations.checkInNotValid),void this.reservationForm.setFormNormalMode();var n=this;l.ajax({url:MPHB._data.ajaxUrl,type:"GET",dataType:"json",data:{action:"mphb_get_free_accommodations_amount",mphb_nonce:MPHB._data.nonces.mphb_get_free_accommodations_amount,typeId:this.typeId,checkInDate:l.datepick.formatDate(MPHB._data.settings.dateTransferFormat,a),checkOutDate:l.datepick.formatDate(MPHB._data.settings.dateTransferFormat,i),adults:this.reservationForm.getAdults(),children:this.reservationForm.getChildren(),lang:MPHB._data.settings.currentLanguage},success:function(e){e.success?(n.resetQuantityOptions(e.data.freeCount),n.setupPrice(e.data.price,e.data.priceHtml),n.showSections(0<e.data.price)):n.showError(e.data.message)},error:function(e){n.showError(MPHB._data.translations.errorHasOccured)},complete:function(e){n.reservationForm.setFormNormalMode()}})}}),MPHB.ReservationForm=can.Control.extend({MODE_SUBMIT:"submit",MODE_NORMAL:"normal",MODE_WAITING:"waiting"},{formEl:null,checkInDatepicker:null,checkOutDatepicker:null,reserveBtn:null,reserveBtnPreloader:null,errorsWrapper:null,isDirectBooking:!1,directBooking:null,mode:null,roomTypeId:null,searchRoomTypeId:null,roomTypeData:null,setup:function(e,t){this._super(e,t),this.mode=MPHB.ReservationForm.MODE_NORMAL},init:function(e,t){this.formEl=e,this.roomTypeId=parseInt(this.formEl.attr("id").replace(/^booking-form-/,"")),this.isDirectBooking="1"==MPHB._data.settings.isDirectBooking,this.roomTypeData=MPHB.HotelDataManager.myThis.getRoomTypeData(this.roomTypeId),this.originalRoomTypeId=this.roomTypeData.originalId,this.searchRoomTypeId=this.isDirectBooking?this.originalRoomTypeId:0,this.errorsWrapper=this.formEl.find(".mphb-errors-wrapper"),this.initCheckInDatepicker(),this.initCheckOutDatepicker(),this.initReserveBtn(),this.isDirectBooking&&(this.directBooking=new MPHB.DirectBooking(e,{reservationForm:this})),l(window).on("mphb-update-date-room-type-"+this.roomTypeId,this.proxy(function(){this.refreshDatepickers()})),this.checkInDatepicker.getDate()&&this.updateCheckOutLimitations()},getAdults:function(){var e=this.formEl.find('[name="mphb_adults"]');return 0<e.length?parseInt(e.val()):""},getChildren:function(){var e=this.formEl.find('[name="mphb_children"]');return 0<e.length?parseInt(e.val()):""},proceedToCheckout:function(){this.mode=MPHB.ReservationForm.MODE_SUBMIT,this.unlock(),this.formEl.submit()},showError:function(e){this.clearErrors();var t=l("<p>",{class:"mphb-error",html:e});this.errorsWrapper.append(t).removeClass("mphb-hide")},clearErrors:function(){this.errorsWrapper.empty().addClass("mphb-hide")},lock:function(){this.element.find("[name]").attr("disabled","disabled"),this.reserveBtn.attr("disabled","disabled").addClass("mphb-disabled"),this.reserveBtnPreloader.removeClass("mphb-hide")},unlock:function(){this.element.find("[name]").removeAttr("disabled"),this.reserveBtn.removeAttr("disabled").removeClass("mphb-disabled"),this.reserveBtnPreloader.addClass("mphb-hide")},setFormWaitingMode:function(){this.mode=MPHB.ReservationForm.MODE_WAITING,this.lock()},setFormNormalMode:function(){this.mode=MPHB.ReservationForm.MODE_NORMAL,this.unlock()},initCheckInDatepicker:function(){var e=this.formEl.find('input[type="text"][id^=mphb_check_in_date]');this.checkInDatepicker=new MPHB.RoomTypeCheckInDatepicker(e,{form:this,roomTypeId:this.searchRoomTypeId}),this.updateCheckInLimitations()},initCheckOutDatepicker:function(){var e=this.formEl.find('input[type="text"][id^=mphb_check_out_date]');this.checkOutDatepicker=new MPHB.RoomTypeCheckOutDatepicker(e,{form:this,roomTypeId:this.searchRoomTypeId})},initReserveBtn:function(){this.reserveBtn=this.formEl.find(".mphb-reserve-btn"),this.reserveBtnPreloader=this.formEl.find(".mphb-preloader"),this.setFormNormalMode()},updateCheckInLimitations:function(e){void 0===e&&(e=!0);var t=this.retrieveCheckInLimitations();this.checkInDatepicker.setOption("maxAdvanceDate",t.maxAdvanceDate)},updateCheckOutLimitations:function(e){void 0===e&&(e=!0);var t=this.retrieveCheckOutLimitations(this.checkInDatepicker.getDate(),this.checkOutDatepicker.getDate());this.checkOutDatepicker.setOption("minDate",t.minDate),this.checkOutDatepicker.setOption("maxDate",t.maxDate),this.checkOutDatepicker.setDate(e?t.date:null)},retrieveCheckInLimitations:function(){return{maxAdvanceDate:MPHB.HotelDataManager.myThis.reservationRules.getMaxAdvanceDate(this.checkInDatepicker.roomTypeId)}},retrieveCheckOutLimitations:function(e,t){var a=MPHB.HotelDataManager.myThis.today,i=null,n=null;return null!==e&&(a=MPHB.HotelDataManager.myThis.reservationRules.getMinCheckOutDate(e,this.searchRoomTypeId),i=MPHB.HotelDataManager.myThis.reservationRules.getMaxCheckOutDate(e,this.searchRoomTypeId),this.isDirectBooking&&(i=this.roomTypeData.getNearestLockedCheckOutDate(e,i),i=this.roomTypeData.getNearestHaveNotPriceDate(e,i)),i=MPHB.HotelDataManager.myThis.dateRules.getNearestNotStayInDate(e,i),n=this.isCheckOutDateNotValid(e,t,a,i)?this.retrieveRecommendedCheckOutDate(e,a,i):t),{minDate:a,maxDate:i,date:n}},retrieveRecommendedCheckOutDate:function(e,t,a){for(var i=null,n=MPHB.Utils.cloneDate(t);MPHB.Utils.formatDateToCompare(n)<=MPHB.Utils.formatDateToCompare(a);){var s=l.datepick.add(MPHB.Utils.cloneDate(n),-1,"d");if(!this.isCheckOutDateNotValid(e,n,t,a)&&(!this.isDirectBooking||this.roomTypeData.hasPriceForDate(s))){i=n;break}n=l.datepick.add(n,1,"d")}return i},isCheckOutDateNotValid:function(e,t,a,i){return null===t||MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(a)||MPHB.Utils.formatDateToCompare(t)>MPHB.Utils.formatDateToCompare(i)||!MPHB.HotelDataManager.myThis.reservationRules.isCheckOutSatisfy(e,t,this.searchRoomTypeId)||!MPHB.HotelDataManager.myThis.dateRules.canCheckOut(t)},clearDatepickers:function(){this.checkInDatepicker.clear(),this.checkOutDatepicker.clear()},refreshDatepickers:function(){this.checkInDatepicker.refresh(),this.checkOutDatepicker.refresh()},onDatepickChange:function(){null!=this.directBooking&&this.directBooking.hideSections()}}),MPHB.RoomTypeCalendar=can.Control.extend({},{roomTypeData:null,roomTypeId:null,init:function(e,t){this.roomTypeId=parseInt(e.attr("id").replace(/^mphb-calendar-/,"")),this.roomTypeData=MPHB.HotelDataManager.myThis.getRoomTypeData(this.roomTypeId);var a=MPHB._data.settings.numberOfMonthCalendar,i=e.attr("data-monthstoshow");if(i){var n=i.split(",");a=1==n.length?parseInt(i):n}var s=MPHB.HotelDataManager.myThis.reservationRules.getMinCheckInDate(this.roomTypeId);e.hide().datepick({onDate:this.proxy(function(e,t){var a={selectable:!1,dateClass:"mphb-date-cell",title:"",roomTypeId:this.roomTypeId};return t?a=this.roomTypeData.fillDateData(a,e):a.dateClass+=" mphb-extra-date",a}),minDate:s,monthsToShow:a,firstDay:MPHB._data.settings.firstDay,pickerClass:MPHB._data.settings.datepickerClass,useMouseWheel:!1}).show(),l(window).on("mphb-update-room-type-data-"+this.roomTypeId,this.proxy(function(e){this.refresh()}))},refresh:function(){this.element.hide(),l.datepick._update(this.element[0],!0),this.element.show()}}),MPHB.Datepicker("MPHB.RoomTypeCheckInDatepicker",{},{isDirectBooking:!1,init:function(e,t){this._super(e,t),this.isDirectBooking="1"==MPHB._data.settings.isDirectBooking,0===this.roomTypeId&&(this.roomTypeId=t.form.hasOwnProperty("roomTypeId")?t.form.roomTypeId:0)},getDatepickSettings:function(){return{minDate:MPHB.HotelDataManager.myThis.reservationRules.getMinCheckInDate(this.roomTypeId),onDate:this.proxy(function(e,t){var a={dateClass:"mphb-date-cell",selectable:!1,title:"",roomTypeId:this.roomTypeId};if(t){var i=MPHB.Utils.compareDates(e,MPHB.HotelDataManager.myThis.reservationRules.getMinCheckInDate(this.roomTypeId),"<"),n=null!==this.getMaxAdvanceDate()&&MPHB.Utils.compareDates(e,this.getMaxAdvanceDate(),">"),s=!i&&!n&&MPHB.HotelDataManager.myThis.reservationRules.isCheckInSatisfy(e,this.roomTypeId)&&MPHB.HotelDataManager.myThis.dateRules.canCheckIn(e);this.isDirectBooking?(a=this.form.roomTypeData.fillDateData(a,e,"checkIn"),s=s&&this.form.roomTypeData.canCheckIn(e)):(this.form.roomTypeData.isEarlierThanToday(e)&&(a.dateClass+=" mphb-past-date",a.title+=" "+MPHB._data.translations.past),a=MPHB.HotelDataManager.myThis.fillDateCellData(a,e,"checkIn")),s&&(a.selectable=!0)}else a.dateClass+=" mphb-extra-date";return a.selectable?a.dateClass+=" mphb-date-selectable":a.dateClass+=" mphb-unselectable-date",a}),onSelect:this.proxy(function(e){this.form.updateCheckOutLimitations(),this.form.onDatepickChange()}),pickerClass:"mphb-datepick-popup mphb-check-in-datepick "+MPHB._data.settings.datepickerClass}},setDate:function(e){return null==e?this._super(e):MPHB.HotelDataManager.myThis.reservationRules.isCheckInSatisfy(e,this.roomTypeId)&&MPHB.HotelDataManager.myThis.dateRules.canCheckIn(e)?this._super(e):this._super(null)}}),MPHB.RoomTypeCheckOutDatepicker=MPHB.Datepicker.extend({},{getDatepickSettings:function(){return{onDate:this.proxy(function(e,t){var a={dateClass:"mphb-date-cell",selectable:!1,title:"",roomTypeId:this.roomTypeId};if(t){var i=this.form.checkInDatepicker.getDate(),n=null!==this.getMinDate()&&MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(this.getMinDate()),s=null!==this.getMaxDate()&&MPHB.Utils.formatDateToCompare(e)>MPHB.Utils.formatDateToCompare(this.getMaxDate());if(null!==i&&MPHB.Utils.formatDateToCompare(e)===MPHB.Utils.formatDateToCompare(i)&&(a.dateClass+=" mphb-check-in-date",a.title+=MPHB._data.translations.checkInDate),n){var r=!!i&&MPHB.HotelDataManager.myThis.reservationRules.getMinCheckOutDate(i,this.roomTypeId);MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(i)?a.dateClass+=" mphb-earlier-min-date mphb-earlier-check-in-date":r&&MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(r)&&(a.dateClass+=" mphb-earlier-min-date",a.title+=(a.title.length?" ":"")+MPHB._data.translations.lessThanMinDaysStay)}if(s){var o=!!i&&MPHB.HotelDataManager.myThis.reservationRules.getMaxCheckOutDate(i,this.roomTypeId);!o||MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(o)?a.title+=(a.title.length?" ":"")+MPHB._data.translations.laterThanMaxDate:a.title+=(a.title.length?" ":"")+MPHB._data.translations.moreThanMaxDaysStay,a.dateClass+=" mphb-later-max-date"}a=this.isDirectBooking?this.form.roomTypeData.fillDateData(a,e,"checkOut",i):(this.form.roomTypeData.isEarlierThanToday(e)&&(a.dateClass+=" mphb-past-date",a.title+=" "+MPHB._data.translations.past),MPHB.HotelDataManager.myThis.fillDateCellData(a,e,"checkOut",i)),!n&&!s&&MPHB.HotelDataManager.myThis.reservationRules.isCheckOutSatisfy(i,e,this.roomTypeId)&&MPHB.HotelDataManager.myThis.dateRules.canCheckOut(e)&&(a.selectable=!0)}else a.dateClass+=" mphb-extra-date";return a.selectable?a.dateClass+=" mphb-selectable-date":a.dateClass+=" mphb-unselectable-date",a}),onSelect:this.proxy(function(e){this.form.onDatepickChange()}),pickerClass:"mphb-datepick-popup mphb-check-out-datepick "+MPHB._data.settings.datepickerClass}},setDate:function(e){if(null==e)return this._super(e);var t=this.form.checkInDatepicker.getDate();return MPHB.HotelDataManager.myThis.reservationRules.isCheckOutSatisfy(t,e,this.roomTypeId)&&MPHB.HotelDataManager.myThis.dateRules.canCheckOut(e)?this._super(e):this._super(null)}}),MPHB.RoomTypeData=can.Construct.extend({},{id:null,originalId:null,bookedDates:{},checkInDates:{},checkOutDates:{},blockedDates:{},havePriceDates:{},activeRoomsCount:0,init:function(e,t){this.id=e,this.originalId=t.originalId,this.setRoomsCount(t.activeRoomsCount),this.setDates(t.dates)},update:function(e){e.hasOwnProperty("activeRoomsCount")&&this.setRoomsCount(e.activeRoomsCount),e.hasOwnProperty("dates")&&this.setDates(e.dates),l(window).trigger("mphb-update-room-type-data-"+this.id)},setRoomsCount:function(e){this.activeRoomsCount=e},setDates:function(e){this.bookedDates=e.hasOwnProperty("booked")?e.booked:{},this.checkInDates=e.hasOwnProperty("checkIns")?e.checkIns:{},this.checkOutDates=e.hasOwnProperty("checkOuts")?e.checkOuts:{},this.blockedDates=e.hasOwnProperty("blocked")?e.blocked:{},this.havePriceDates=e.hasOwnProperty("havePrice")?e.havePrice:{}},blockAllRoomsOnDate:function(e){this.blockedDates[e]=this.activeRoomsCount},getNearestLockedCheckOutDate:function(e,t){var a=t,i=this.activeRoomsCount,n=l.datepick.formatDate("yyyy-mm-dd",e),s=l.datepick.formatDate("yyyy-mm-dd",t);return l.each(this.getLockedCheckoutDates(),function(e,t){return!(s<e)&&(e<n||(i<=t?(a=l.datepick.parseDate("yyyy-mm-dd",e),!1):void 0))}),a},getLockedCheckoutDates:function(){var a=l.extend({},this.bookedDates);return l.each(this.blockedDates,function(e,t){a.hasOwnProperty(e)?a[e]+=t:a[e]=t}),a},getNearestHaveNotPriceDate:function(e,t){for(var a=MPHB.Utils.cloneDate(t),i=MPHB.Utils.cloneDate(e);MPHB.Utils.formatDateToCompare(i)<=MPHB.Utils.formatDateToCompare(t);){if(!this.hasPriceForDate(i)){a=i;break}i=l.datepick.add(i,1,"d")}return a},getHavePriceDates:function(){return l.extend({},this.havePriceDates)},getDateStatus:function(e){var t=MPHB.HotelDataManager.ROOM_STATUS_AVAILABLE;return this.isEarlierThanToday(e)?t=MPHB.HotelDataManager.ROOM_STATUS_PAST:this.isDateBooked(e)?t=MPHB.HotelDataManager.ROOM_STATUS_BOOKED:MPHB.HotelDataManager.myThis.isEarlierThanMinAdvanceDate(e,this.originalId)?t=MPHB.HotelDataManager.ROOM_STATUS_EARLIER_MIN_ADVANCE:MPHB.HotelDataManager.myThis.isLaterThamMaxAdvanceDate(e,this.originalId)?t=MPHB.HotelDataManager.ROOM_STATUS_LATER_MAX_ADVANCE:this.hasPriceForDate(e)&&this.getAvailableRoomsCount(e)||(t=MPHB.HotelDataManager.ROOM_STATUS_NOT_AVAILABLE),t},canCheckIn:function(e){return this.getDateStatus(e)==MPHB.HotelDataManager.ROOM_STATUS_AVAILABLE},isDateBooked:function(e){var t=l.datepick.formatDate("yyyy-mm-dd",e);return this.bookedDates.hasOwnProperty(t)&&this.bookedDates[t]>=this.activeRoomsCount},isDateBookingCheckIn:function(e){var t=l.datepick.formatDate("yyyy-mm-dd",e);return this.checkInDates.hasOwnProperty(t)},isDateBookingCheckOut:function(e){var t=l.datepick.formatDate("yyyy-mm-dd",e);return!!this.checkOutDates.hasOwnProperty(t)&&(this.bookedDates.hasOwnProperty(t)?this.checkOutDates[t]+this.bookedDates[t]>=this.activeRoomsCount:this.checkOutDates[t]>=this.activeRoomsCount)},hasPriceForDate:function(e){var t=l.datepick.formatDate("yyyy-mm-dd",e);return MPHB.Utils.inArray(t,this.havePriceDates)},getAvailableRoomsCount:function(e){var t=l.datepick.formatDate("yyyy-mm-dd",e),a=this.activeRoomsCount;return this.bookedDates.hasOwnProperty(t)&&(a-=this.bookedDates[t]),this.blockedDates.hasOwnProperty(t)&&(a-=this.blockedDates[t]),a<0&&(a=0),a},fillDateData:function(e,t,a,i){i=i||t;var n=[],s=[];switch(this.getDateStatus(t)){case MPHB.HotelDataManager.ROOM_STATUS_PAST:s.push("mphb-past-date"),n.push(MPHB._data.translations.past);break;case MPHB.HotelDataManager.ROOM_STATUS_AVAILABLE:s.push("mphb-available-date"),n.push(MPHB._data.translations.available+"("+this.getAvailableRoomsCount(t)+")"),this.isDateBookingCheckOut(t)&&s.push("mphb-date-check-out");break;case MPHB.HotelDataManager.ROOM_STATUS_NOT_AVAILABLE:s.push("mphb-not-available-date"),n.push(MPHB._data.translations.notAvailable);break;case MPHB.HotelDataManager.ROOM_STATUS_BOOKED:s.push("mphb-booked-date"),n.push(MPHB._data.translations.booked),this.isDateBookingCheckIn(t)&&s.push("mphb-date-check-in"),this.isDateBookingCheckOut(t)&&s.push("mphb-date-check-out");break;case MPHB.HotelDataManager.ROOM_STATUS_EARLIER_MIN_ADVANCE:case MPHB.HotelDataManager.ROOM_STATUS_LATER_MAX_ADVANCE:n.push(MPHB._data.translations.notAvailable),this.isDateBookingCheckOut(t)&&(s.push("mphb-booked-date"),s.push("mphb-date-check-out"),s.push("mphb-available-date"))}return e.dateClass+=(e.dateClass.length?" ":"")+s.join(" "),e.title+=(e.title.length?", ":"")+n.join(", "),e=MPHB.HotelDataManager.myThis.fillDateCellData(e,t,a,i)},appendRulesToTitle:function(e,t){var a=[];return MPHB.HotelDataManager.myThis.dateRules.canStayIn(e)||a.push(MPHB._data.translations.notStayIn),MPHB.HotelDataManager.myThis.dateRules.canCheckIn(e)||a.push(MPHB._data.translations.notCheckIn),MPHB.HotelDataManager.myThis.dateRules.canCheckOut(e)||a.push(MPHB._data.translations.notCheckOut),a.length&&(t+=" "+MPHB._data.translations.rules+" "+a.join(", ")),t},isEarlierThanToday:function(e){return MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(MPHB.HotelDataManager.myThis.today)}}),MPHB.Rules.BasicRule("MPHB.Rules.MaxAdvanceDaysRule",{},{max:null,init:function(e){this._super(e),this.max=0!=e.max_advance_reservation?e.max_advance_reservation:3652},verify:function(e,t){var a=l.datepick.add(MPHB.Utils.cloneDate(MPHB.HotelDataManager.myThis.today),this.max,"d");return MPHB.Utils.compareDates(e,a,"<=")}}),MPHB.Rules.BasicRule("MPHB.Rules.MinAdvanceDaysRule",{},{min:null,init:function(e){this._super(e),this.min=e.min_advance_reservation},verify:function(e,t){var a=l.datepick.add(MPHB.Utils.cloneDate(MPHB.HotelDataManager.myThis.today),this.min,"d");return MPHB.Utils.compareDates(a,e,"<=")}}),MPHB.SearchCheckInDatepicker=MPHB.Datepicker.extend({},{getDatepickSettings:function(){return{minDate:MPHB.HotelDataManager.myThis.reservationRules.getMinCheckInDate(this.roomTypeId),onSelect:this.proxy(function(e){this.form.updateCheckOutLimitations()}),onDate:this.proxy(function(e,t){var a={dateClass:"mphb-date-cell",selectable:!1,title:""},i=null!==this.getMaxAdvanceDate()&&MPHB.Utils.compareDates(e,this.getMaxAdvanceDate(),">"),n=MPHB.Utils.compareDates(e,this.getMinDate(),"<");t?(!i&&!n&&MPHB.HotelDataManager.myThis.reservationRules.isCheckInSatisfy(e,this.roomTypeId)&&MPHB.HotelDataManager.myThis.dateRules.canCheckIn(e)&&(a.selectable=!0),a=MPHB.HotelDataManager.myThis.fillDateCellData(a,e,"checkIn")):a.dateClass+=" mphb-extra-date";return a.selectable?a.dateClass+=" mphb-selectable-date":a.dateClass+=" mphb-unselectable-date",a}),pickerClass:"mphb-datepick-popup mphb-check-in-datepick "+MPHB._data.settings.datepickerClass}}}),MPHB.SearchCheckOutDatepicker=MPHB.Datepicker.extend({},{getDatepickSettings:function(){return{onDate:this.proxy(function(e,t){var a={dateClass:"mphb-date-cell",selectable:!1,title:""};if(t){var i=this.form.checkInDatepicker.getDate(),n=null!==this.getMinDate()&&MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(this.getMinDate()),s=null!==this.getMaxDate()&&MPHB.Utils.formatDateToCompare(e)>MPHB.Utils.formatDateToCompare(this.getMaxDate());if(null!==i&&MPHB.Utils.formatDateToCompare(e)===MPHB.Utils.formatDateToCompare(i)&&(a.dateClass+=" mphb-check-in-date",a.title+=MPHB._data.translations.checkInDate),n&&(MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(i)?a.dateClass+=" mphb-earlier-min-date mphb-earlier-check-in-date":(a.dateClass+=" mphb-earlier-min-date",a.title+=(a.title.length?" ":"")+MPHB._data.translations.lessThanMinDaysStay)),s){var r=!!i&&MPHB.HotelDataManager.myThis.reservationRules.getMaxCheckOutDate(i,this.roomTypeId);!r||MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(r)?a.title+=(a.title.length?" ":"")+MPHB._data.translations.laterThanMaxDate:a.title+=(a.title.length?" ":"")+MPHB._data.translations.moreThanMaxDaysStay,a.dateClass+=" mphb-later-max-date"}a=MPHB.HotelDataManager.myThis.fillDateCellData(a,e,"checkOut",i),!n&&!s&&MPHB.HotelDataManager.myThis.reservationRules.isCheckOutSatisfy(i,e,this.roomTypeId)&&MPHB.HotelDataManager.myThis.dateRules.canCheckOut(e)&&(a.selectable=!0)}else a.dateClass+=" mphb-extra-date";return a.selectable?a.dateClass+=" mphb-selectable-date":a.dateClass+=" mphb-unselectable-date",a}),pickerClass:"mphb-datepick-popup mphb-check-out-datepick "+MPHB._data.settings.datepickerClass}}}),MPHB.SearchForm=can.Control.extend({},{checkInDatepickerEl:null,checkOutDatepickerEl:null,checkInDatepicker:null,checkOutDatepicker:null,init:function(e,t){this.checkInDatepickerEl=this.element.find('.mphb-datepick[id^="mphb_check_in_date"]'),this.checkOutDatepickerEl=this.element.find('.mphb-datepick[id^="mphb_check_out_date"]'),this.checkInDatepicker=new MPHB.SearchCheckInDatepicker(this.checkInDatepickerEl,{form:this}),this.checkOutDatepicker=new MPHB.SearchCheckOutDatepicker(this.checkOutDatepickerEl,{form:this}),this.updateCheckInLimitations(),this.checkInDatepicker.getDate()&&this.updateCheckOutLimitations()},updateCheckInLimitations:function(){var e=this.retrieveCheckInLimitations();this.checkInDatepicker.setOption("maxAdvanceDate",e.maxAdvanceDate)},updateCheckOutLimitations:function(e){void 0===e&&(e=!0);var t=this.retrieveCheckOutLimitations(this.checkInDatepicker.getDate(),this.checkOutDatepicker.getDate());this.checkOutDatepicker.setOption("minDate",t.minDate),this.checkOutDatepicker.setOption("maxDate",t.maxDate),this.checkOutDatepicker.setDate(e?t.date:null)},retrieveCheckOutLimitations:function(e,t){var a=MPHB.HotelDataManager.myThis.today,i=null,n=null;if(null!==e){a=MPHB.HotelDataManager.myThis.reservationRules.getMinCheckOutDate(e),i=MPHB.HotelDataManager.myThis.reservationRules.getMaxCheckOutDate(e);i=MPHB.HotelDataManager.myThis.dateRules.getNearestNotStayInDate(e,i),n=this.isCheckOutDateNotValid(e,t,a,i)?this.retrieveRecommendedCheckOutDate(e,a,i):t}return{minDate:a,maxDate:i,date:n}},retrieveCheckInLimitations:function(){return{maxAdvanceDate:MPHB.HotelDataManager.myThis.reservationRules.getMaxAdvanceDate(this.checkInDatepicker.roomTypeId)}},retrieveRecommendedCheckOutDate:function(e,t,a){for(var i=null,n=MPHB.Utils.cloneDate(t);MPHB.Utils.formatDateToCompare(n)<=MPHB.Utils.formatDateToCompare(a);){if(!this.isCheckOutDateNotValid(e,n,t,a)){i=n;break}n=l.datepick.add(n,1,"d")}return i},isCheckOutDateNotValid:function(e,t,a,i){return null===t||MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(a)||MPHB.Utils.formatDateToCompare(t)>MPHB.Utils.formatDateToCompare(i)||!MPHB.HotelDataManager.myThis.reservationRules.isCheckOutSatisfy(e,t)||!MPHB.HotelDataManager.myThis.dateRules.canCheckOut(t)}}),MPHB.RoomBookSection=can.Control.extend({},{roomTypeId:null,roomTitle:"",roomPrice:0,quantitySelect:null,bookButton:null,confirmButton:null,removeButton:null,messageHolder:null,messageWrapper:null,form:null,init:function(e,t){this.reservationCart=t.reservationCart,this.roomTypeId=parseInt(e.attr("data-room-type-id")),this.roomTitle=e.attr("data-room-type-title"),this.roomPrice=parseFloat(e.attr("data-room-price")),this.confirmButton=e.find(".mphb-confirm-reservation"),this.quantitySelect=e.find(".mphb-rooms-quantity"),this.messageWrapper=e.find(".mphb-rooms-reservation-message-wrapper"),this.messageHolder=e.find(".mphb-rooms-reservation-message")},getRoomTypeId:function(){return this.roomTypeId},getPrice:function(){return this.roomPrice},".mphb-book-button click":function(e,t){t.preventDefault(),t.stopPropagation();var a=parseInt(this.quantitySelect.val());if(this.reservationCart.addToCart(this.roomTypeId,a),MPHB._data.settings.isDirectBooking)e.prop("disabled",!0),this.reservationCart.confirmReservation();else{var i=(1==a?MPHB._data.translations.roomsAddedToReservation_singular:MPHB._data.translations.roomsAddedToReservation_plural).replace("%1$d",a).replace("%2$s",this.roomTitle);this.messageHolder.html(i),this.element.addClass("mphb-rooms-added")}},".mphb-remove-from-reservation click":function(e,t){t.preventDefault(),t.stopPropagation(),this.reservationCart.removeFromCart(this.roomTypeId),this.messageHolder.empty(),this.element.removeClass("mphb-rooms-added")},".mphb-confirm-reservation click":function(e,t){t.preventDefault(),t.stopPropagation(),this.reservationCart.confirmReservation()}}),MPHB.ReservationCart=can.Control.extend({},{cartForm:null,cartDetails:null,roomBookSections:{},cartContents:{},init:function(e,t){this.cartForm=e.find("#mphb-reservation-cart"),this.cartDetails=e.find(".mphb-reservation-details"),this.initRoomBookSections(e.find(".mphb-reserve-room-section"))},initRoomBookSections:function(e){var a,i=this;l.each(e,function(e,t){a=new MPHB.RoomBookSection(l(t),{reservationCart:i}),i.roomBookSections[a.getRoomTypeId()]=a})},addToCart:function(e,t){this.cartContents[e]=t,this.updateCartView(),this.updateCartInputs()},removeFromCart:function(e){delete this.cartContents[e],this.updateCartView(),this.updateCartInputs()},calcRoomsInCart:function(){var a=0;return l.each(this.cartContents,function(e,t){a+=t}),a},calcTotalPrice:function(){var a=0,i=0,n=this;return l.each(this.cartContents,function(e,t){i=n.roomBookSections[e].getPrice(),a+=i*t}),a},updateCartView:function(){if(l.isEmptyObject(this.cartContents))this.cartForm.addClass("mphb-empty-cart");else{var e=this.calcRoomsInCart(),t=(1==e?MPHB._data.translations.countRoomsSelected_singular:MPHB._data.translations.countRoomsSelected_plural).replace("%s",e);this.cartDetails.find(".mphb-cart-message").html(t);var a=this.calcTotalPrice(),i=MPHB.format_price(a,{trim_zeros:!0});this.cartDetails.find(".mphb-cart-total-price>.mphb-cart-total-price-value").html(i),this.cartForm.removeClass("mphb-empty-cart")}},updateCartInputs:function(){this.cartForm.find('[name^="mphb_rooms_details"]').remove();var i=this;l.each(this.cartContents,function(e,t){var a=l("<input />",{name:"mphb_rooms_details["+e+"]",type:"hidden",value:t});i.cartForm.prepend(a)})},confirmReservation:function(){this.cartForm.submit()}}),MPHB.StripeGateway.PaymentMethods=can.Construct.extend({},{listAll:["card","bancontact","ideal","giropay","sepa_debit","sofort"],listEnabled:["card"],paymentMethods:{},currentPayment:"card",currentCountry:"",inputs:null,isMounted:!1,init:function(e,t){this.listEnabled=e.slice(0),this.initPayments(),this.selectCountry(t)},initPayments:function(){var t=this;this.forEach(function(e){t.paymentMethods[e]={isEnabled:0<=t.listEnabled.indexOf(e),nav:null,fields:null}})},selectPayment:function(e){e!=this.currentPayment&&this.paymentMethods.hasOwnProperty(e)&&(this.togglePayment(this.currentPayment,!1),this.togglePayment(e,!0),this.currentPayment=e)},togglePayment:function(e,t){this.isMounted&&(this.paymentMethods[e].nav.toggleClass("active",t),this.paymentMethods[e].fields.toggleClass("mphb-hide",!t))},selectCountry:function(e){this.currentCountry!=e&&(this.currentCountry=e,this.currentPayment="card",this.showRelevantMethods())},showRelevantMethods:function(){if(this.isMounted){var a=this.currentPayment;this.forEach(function(e,t){t.fields.toggleClass("mphb-hide",e!=a)}),this.inputs.val([a])}},mount:function(a){this.forEach(function(e,t){t.nav=a.find(".mphb-stripe-payment-method."+e),t.fields=a.find(".mphb-stripe-payment-fields."+e)}),this.inputs=a.find('input[name="stripe_payment_method"]'),this.isMounted=!0},unmount:function(){this.forEach(function(e,t){t.nav=null,t.fields=null}),this.inputs=null,this.isMounted=!1},forEach:function(t){var a=this;this.listAll.forEach(function(e){t(e,a.paymentMethods[e],a)})},isEnabled:function(e){return this.paymentMethods[e].isEnabled},onlyCardEnabled:function(){return 1==this.listEnabled.length&&this.paymentMethods.card.isEnabled},isSelected:function(e){return e==this.currentPayment}}),new MPHB.HotelDataManager(MPHB._data),MPHB._data.page.isCheckoutPage?new MPHB.CheckoutForm(l(".mphb_sc_checkout-form")):MPHB._data.page.isCreateBookingPage&&new MPHB.CheckoutForm(l(".mphb_cb_checkout_form")),MPHB._data.page.isSearchResultsPage&&new MPHB.ReservationCart(l(".mphb_sc_search_results-wrapper"));var e=l(".mphb-calendar.mphb-datepick");l.each(e,function(e,t){new MPHB.RoomTypeCalendar(l(t))});var t=l(".mphb-booking-form");l.each(t,function(e,t){new MPHB.ReservationForm(l(t))});var a=l("form.mphb_sc_search-form, form.mphb_widget_search-form, form.mphb_cb_search_form");l.each(a,function(e,t){new MPHB.SearchForm(l(t))});var i=l(".mphb-flexslider-gallery-wrapper");l.each(i,function(e,t){new MPHB.FlexsliderGallery(t)});var n=l(".mphb-checkout-terms-wrapper");0<n.length&&new MPHB.TermsSwitcher(n),null==l.ui&&(l.ui={}),null==l.ui.version&&(l.ui.version="1.5-")})}(jQuery);